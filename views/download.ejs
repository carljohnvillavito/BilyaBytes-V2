<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download Files | CloudShare Pro</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    
    <%
    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // NEW: Filename Formatter Function
    // Output: Filename-12-02-2025.ext
    function getCustomDownloadUrl(url, cleanName, ext) {
        const d = new Date();
        // Format: MM-DD-YYYY
        const dateStr = String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                        String(d.getDate()).padStart(2, '0') + '-' + 
                        d.getFullYear();
        
        const newFilename = `${cleanName}-${dateStr}${ext}`;
        
        // Cloudinary Injection: /fl_attachment:new_filename/
        return url.replace('/upload/', `/upload/fl_attachment:${newFilename}/`);
    }
    %>

    <div class="card" style="width: 100%; max-width: 600px;">
        <% if (error) { %>
            <div class="text-center">
                <span style="font-size: 3rem;">⚠️</span>
                <h2>Link Expired or Invalid</h2>
                <p class="text-muted"><%= error %></p>
                <a href="/" class="btn btn-primary mt-2" style="display:inline-block; width:auto;">Create New Transfer</a>
            </div>
        <% } else { %>
            
            <div class="download-hero">
                <span class="logo">⚡ CloudShare Pro</span>
                <h2><%= container.name %></h2>
                
                <!-- FIX: Client-side Time Conversion -->
                <div class="expiry-box">
                    Expires: <span id="local-expiry">Calculating...</span>
                </div>
                
                <script>
                    const expiryDate = new Date("<%= container.expiresAt.toISOString() %>");
                    const now = new Date();
                    
                    // Format to local time string
                    document.getElementById('local-expiry').innerText = expiryDate.toLocaleString();
                    
                    // Optional: Show relative time if close
                    const diffMins = Math.floor((expiryDate - now) / 60000);
                    if (diffMins > 0 && diffMins < 60) {
                        document.getElementById('local-expiry').innerText += ` (in ${diffMins} mins)`;
                    }
                </script>
            </div>

            <div class="file-grid">
                <% container.files.forEach(file => { %>
                    <div class="dl-item">
                        <div class="dl-info">
                            <strong style="color: var(--text-main)"><%= file.originalName %></strong>
                            <span class="dl-size"><%= formatBytes(file.size) %> • <%= file.format %></span>
                        </div>
                        
                        <!-- FIX: Custom Filename URL -->
                        <a href="<%= getCustomDownloadUrl(file.url, file.cleanName, file.extension) %>" class="download-icon">
                            ⬇ Download
                        </a>
                    </div>
                <% }) %>
            </div>

            <div class="text-center mt-2" style="border-top: 1px solid var(--border); padding-top: 2rem; margin-top: 2rem;">
                <p class="text-muted">Want to send files like this?</p>
                <a href="/" class="btn btn-primary">Start Uploading</a>
            </div>
        <% } %>
    </div>

</body>
</html>
