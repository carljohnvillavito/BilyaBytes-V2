<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download Files | CloudShare Pro</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    
    <!-- EJS Helper Functions -->
    <%
    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // FUNCTION TO FORCE DIRECT DOWNLOAD & FIX FILENAME
    function getDirectDownloadUrl(url) {
        // Cloudinary URLs usually look like: .../upload/v12345/name.ext
        // We inject '/fl_attachment' after '/upload/' to force the server 
        // to send the "Content-Disposition: attachment" header.
        return url.replace('/upload/', '/upload/fl_attachment/');
    }
    %>

    <div class="card" style="width: 100%; max-width: 600px;">
        <% if (error) { %>
            <div class="text-center">
                <span style="font-size: 3rem;">⚠️</span>
                <h2>Link Expired or Invalid</h2>
                <p class="text-muted"><%= error %></p>
                <a href="/" class="btn btn-primary mt-2" style="display:inline-block; width:auto;">Create New Transfer</a>
            </div>
        <% } else { %>
            
            <div class="download-hero">
                <span class="logo">⚡ CloudShare Pro</span>
                <h2><%= container.name %></h2>
                <p class="text-muted text-sm">
                    Expires: <%= new Date(container.expiresAt).toLocaleString() %>
                </p>
            </div>

            <div class="file-grid">
                <% container.files.forEach(file => { %>
                    <div class="dl-item">
                        <div class="dl-info">
                            <strong style="color: var(--text-main)"><%= file.originalName %></strong>
                            <span class="dl-size"><%= formatBytes(file.size) %> • <%= file.format %></span>
                        </div>
                        
                        <!-- UPDATED: Uses the direct download URL helper -->
                        <a href="<%= getDirectDownloadUrl(file.url) %>" class="download-icon">
                            ⬇ Download
                        </a>
                    </div>
                <% }) %>
            </div>

            <div class="text-center mt-2" style="border-top: 1px solid var(--border); padding-top: 2rem; margin-top: 2rem;">
                <p class="text-muted">Want to send files like this?</p>
                <a href="/" class="btn btn-primary">Start Uploading</a>
            </div>
        <% } %>
    </div>

</body>
</html>
